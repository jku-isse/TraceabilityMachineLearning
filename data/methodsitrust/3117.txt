/**
 * Returns all the survey results in the database that correspond to a particular zip code.
 *
 * @param zip
 * 		The zipcode we are interested in as a String.
 * @param specialty
 * 		The specialty we are interested in as a String.
 * @return A java.util.List of SurveyResultBeans.
 * @throws DBException
 * 		
 */
public List<SurveyResultBean> getSurveyResultsForZip(String zip, String specialty) throws DBException {
    Connection conn = null;
    PreparedStatement ps = null;
    StringBuffer sql = new StringBuffer();
    sql.append("select p.mid, p.firstname, p.lastname, p.address1, p.address2, p.city, p.state, p.zip, p.specialty, ");
    sql.append("na hospitalID, ");
    sql.append("avg(s.WaitingRoomMinutes) AvgWaitingRoomMinutes, ");
    sql.append("avg(s.ExamRoomMinutes) AvgExamRoomMinutes, ");
    sql.append("avg(s.VisitSatisfaction) AvgVisitSatisfaction, ");
    sql.append("avg(s.TreatmentSatisfaction) AvgTreatmentSatisfation, ");
    sql.append("count(*) / ");
    sql.append("	(select count(*) from personnel p1, officevisits v1 ");
    sql.append("	 where v1.hcpid = p1.mid ");
    sql.append("	 and substr(p1.zip,1,3) = ? ");
    sql.append("	 and p1.mid = p.mid) * 100 PercentSatisfactionResults ");
    sql.append("from ovsurvey s, personnel p, officevisits v ");
    sql.append("where s.visitid = v.id ");
    sql.append("and v.hcpid = p.mid ");
    sql.append("and substr(p.zip,1,3) = ? ");
    if (!(specialty.equals(SurveyResultBean.ANY_SPECIALTY)))
        sql.append("and specialty = ?");

    sql.append("group by p.mid, p.firstname, p.lastname, p.address1, p.address2, p.city, p.state, p.zip, hospitalID ");
    if (!(specialty.equals(SurveyResultBean.ANY_SPECIALTY)))
        sql.append(", p.specialty ");

    sql.append("order by p.mid ");
    try {
        conn = factory.getConnection();
        ps = conn.prepareStatement(sql.toString());
        ps.setString(1, zip.substring(0, 3));
        ps.setString(2, zip.substring(0, 3));
        if (!(specialty.equals(SurveyResultBean.ANY_SPECIALTY)))
            ps.setString(3, specialty);

        return loader.loadList(ps.executeQuery());
    } catch (SQLException e) {
        e.printStackTrace();
        throw new DBException(e);
    } finally {
        DBUtil.closeConnection(conn, ps);
    }
}